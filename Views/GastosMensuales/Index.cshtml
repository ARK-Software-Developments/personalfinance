@using PersonalFinance.Helper
@using PersonalFinance.Models.Gastos
@using System.Globalization
@{
    ViewData["Title"] = ViewBag.Title;
    ViewBag.Ruta = $"{ViewBag.Modulo} > {ViewBag.Title}";
    List<Gasto> gastos = ViewBag.Gastos;

    DateTime fechaActual = DateTime.Now;

    string mesCompletoAnterior = Utils.LetraCapital(fechaActual.AddMonths(-1).ToString("MMMM", new CultureInfo("es-ES")));
    string mesCompletoActual = Utils.LetraCapital(fechaActual.ToString("MMMM", new CultureInfo("es-ES")));
    string mesCompletoSiguiente = Utils.LetraCapital(fechaActual.AddMonths(1).ToString("MMMM", new CultureInfo("es-ES")));

    List<SelectListItem> meses = new List<SelectListItem>();
    for (int i = 1; i <= 12; i++)
    {
        // Formatea el número del mes para obtener el nombre (ej: "Enero", "Febrero")
        string nombreMes = new DateTime(2023, i, 1).ToString("MMMM", new System.Globalization.CultureInfo("es-ES"));
        meses.Add(new SelectListItem { Text = nombreMes, Value = i.ToString() });
    }

    int anoAnterior = DateTime.Now.Year - 1;
    int anoActual = DateTime.Now.Year;

}

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="~/css/personalfinance.styles.css">

<script>
     $(function () {
        $('[data-bs-toggle="tooltip"]').tooltip();
    });


</script>

<div class="text-center">
    <h1 class="display-5">@ViewBag.Message</h1>
    <p>Listado de @ViewBag.Modulo.</p>
</div>

<!-- Estructuras del Modales -->
<div class="modal fade" id="miModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Proceso de copia de Presupuesto Mensual</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Desea confirmar la copia del Presupuesto del Año/Mes?.
            </div>
            <div class="modal-footer" style="display: ruby;">
                <form method="post" asp-controller="@ViewBag.Modulo">
                    <div class="form-group" style="display: ruby;">
                        <table style="position: center;">
                            <tr>
                                <td style="width:50%;">
                                    <div class="form-group">
                                        <span class="form-label">Mes desde:</span>
                                        <select id="MesDesde" name="MesDesde" class="form-control" required>
                                            @foreach (var item in @meses)
                                            {
                                                if (item.Selected)
                                                {
                                                    <option value="@item.Value" selected>@item.Text</option>
                                                }
                                                else
                                                {
                                                    <option value="@item.Value">@item.Text</option>
                                                }
                                            }
                                        </select>
                                        <span class="select-arrow"></span>
                                    </div>
                                </td>
                                <td style="width:50%;">
                                    <div class="form-group">
                                        <span class="form-label">Año Desde:</span>
                                        <input type="text" id="AnoDesde" name="AnoDesde" class="form-control" value="@anoAnterior" required />
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:50%;">
                                    <div class="form-group">
                                        <span class="form-label">Mes hasta:</span>
                                        <select id="MesHasta" name="MesHasta" class="form-control" required>
                                            @foreach (var item in @meses)
                                            {
                                                if (item.Selected)
                                                {
                                                    <option value="@item.Value" selected>@item.Text</option>
                                                }
                                                else
                                                {
                                                    <option value="@item.Value">@item.Text</option>
                                                }
                                            }
                                        </select>
                                        <span class="select-arrow"></span>
                                    </div>
                                </td>
                                <td style="width:50%;">
                                    <div class="form-group">
                                        <span class="form-label">Año hasta:</span>
                                        <input type="text" id="AnoHasta" name="AnoHasta" class="form-control" value="@anoActual" required />
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:50%;"><button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cerrar</button>  </td>
                                <td style="width:50%;"><button type="submit" class="btn btn-primary" asp-controller="@ViewBag.Modulo" asp-action="GastosMensuales" name="action" value="copyBudget">Confirmar</button></td>
                            </tr>
                        </table>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="miModalV" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Proceso de marcado Verificado general</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Desea confirmar en Marcar el Presupuesto del Mes actual a Verificado?.
            </div>
            <div class="modal-footer" style="display: ruby;">
                <form method="post" asp-controller="@ViewBag.Modulo">
                    <div class="form-group" style="display: ruby;">
                        <table style="position: center;">
                            <tr>
                                <td style="width:30%;">
                                    <div class="form-group">
                                        <span class="form-label">Marcar como:</span>
                                    </div>
                                </td>
                                <td style="width:70%;">
                                    <div class="form-group">
                                        <select id="Marca" name="Marca" class="form-control" required>
                                            <option value="1" selected>Vericado</option>
                                            <option value="0">No verificado</option>
                                        </select>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:50%;"><button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cerrar</button>  </td>
                                <td style="width:50%;"><button type="submit" class="btn btn-primary" asp-controller="@ViewBag.Modulo" asp-action="GastosMensuales" name="action" value="verificado">Confirmar</button></td>
                            </tr>
                        </table>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="miModalR" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Proceso de marcado Reservado general</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Desea confirmar en Marcar el Presupuesto del Mes actual a Reservado?.
            </div>
            <div class="modal-footer" style="display: ruby;">
                <form method="post" asp-controller="@ViewBag.Modulo">
                    <div class="form-group" style="display: ruby;">
                        <table style="position: center;">
                            <tr>
                                <td style="width:30%;">
                                    <div class="form-group">
                                        <span class="form-label">Marcar como:</span>
                                    </div>
                                </td>
                                <td style="width:70%;">
                                    <div class="form-group">
                                        <select id="Marca" name="Marca" class="form-control" required>
                                            <option value="1" selected>Reservado</option>
                                            <option value="0">No reservado</option>
                                        </select>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:50%;"><button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cerrar</button>  </td>
                                <td style="width:50%;"><button type="submit" class="btn btn-primary" asp-controller="@ViewBag.Modulo" asp-action="GastosMensuales" name="action" value="reservado">Confirmar</button></td>
                            </tr>
                        </table>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="miModalP" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Proceso de marcado Pagado general</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Desea confirmar en Marcar el Presupuesto del Mes actual a Pagado?.
            </div>
            <div class="modal-footer" style="display: ruby;">
                <form method="post" asp-controller="@ViewBag.Modulo">
                    <div class="form-group" style="display: ruby;">
                        <table style="position: center;">
                            <tr>
                                <td style="width:30%;">
                                    <div class="form-group">
                                        <span class="form-label">Marcar como:</span>
                                    </div>
                                </td>
                                <td style="width:70%;">
                                    <div class="form-group">
                                        <select id="Marca" name="Marca" class="form-control" required>
                                            <option value="1" selected>Pagado</option>
                                            <option value="0">No pagado</option>
                                        </select>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:50%;"><button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cerrar</button>  </td>
                                <td style="width:50%;"><button type="submit" class="btn btn-primary" asp-controller="@ViewBag.Modulo" asp-action="GastosMensuales" name="action" value="pagado">Confirmar</button></td>
                            </tr>
                        </table>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Estructuras del Modales -->

<div class="tab-content">
    <div class="row">
        <div class="datatable-top">
            <div class="datatable-search">

                <form method="get">
                    @if (@ViewBag.Buscar == "Buscar")
                    {
                        <input type="text"
                               name="search"
                               value=""
                               placeholder="Buscar..."
                               class="form-control"
                               style="width: 250px; display:inline-block;" />
                    }


                    <button type="submit" class="btn btn-primary">
                        @ViewBag.Buscar
                    </button>
                </form>

            </div>
        </div>
    </div>
    <p></p>
    <div class="row">
        <table class="table myaccordion table-hover" id="accordion">
            <thead>
                <tr>
                    <th scope="col">Id</th>
                    <th scope="col">Tipo de Gasto</th>
                    <th scope="col">Villetera</th>
                    <th scope="col">@mesCompletoAnterior</th>
                    <th scope="col">@mesCompletoActual</th>
                    <th scope="col">@mesCompletoSiguiente</th>
                    <th scope="col">Resumen</th>
                    <th scope="col">Observaciones</th>
                    <th scope="col" align="center">
                        <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#miModalV" title="Proceso de verificación general">V</button>
                        </th>
                    <th scope="col" align="center">
                        <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#miModalR" title="Proceso de reservado general">R</button>
                    </th>
                    <th scope="col" align="center">
                        <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#miModalP" title="Proceso de pagado general">P</button>
                    </th>
                    <th scope="col">Activo</th>
                    <th colspan="2">
                        &nbsp;
                        <form method="post" asp-controller="Pedidos">
                            <button type="submit" class="btn btn-primary" asp-controller="GastosMensuales" asp-action="GastosMensualesFormAdd" name="action" value="openFormAdd">Nuevo Presupuesto</button>
                            &nbsp;|&nbsp;
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#miModal" title="Copiar presupuesto mes anterior">Copiar Presupuesto</button>
                        </form>
                    </th>
                </tr>
            </thead>
            <tbody>
                @foreach (var entidad in @gastos)
                {
                    var collapseN = "#collapse" + entidad.Id;
                    var collapse = "collapse" + entidad.Id;
                    var mesActual = DateTime.Now.Month;
                    var colorMayor = "background-color: #E89B3C;";
                    var colorMenor = "background-color: #A7C282;";

                    var difMeses = Utils.CalcularDiferenciasMeses(mesActual, Utils.CargarMeses<Gasto>(entidad));

                    decimal gastoMesAnterior = difMeses["anterior"];
                    decimal gastoMesActual = difMeses["actual"];
                    decimal gastoMesSiguiente = difMeses["siguiente"];
                    var checkedV = entidad.Verificado ? "checked" : string.Empty;
                    var checkedR = entidad.Reservado ? "checked" : string.Empty;
                    var checkedP = entidad.Pagado ? "checked" : string.Empty;
                    var checkedA = entidad.Activo ? "checked" : string.Empty;

                    <tr>
                        <td scope="row" id="Id">@entidad.Id</td>
                        <td scope="row" id="Tipo">@entidad.TipoGasto.Tipo</td>
                        <td scope="row" id="Villetera">@entidad.Villetera.Tipo</td>
                        <td scope="row" id="MesAnterior" style="padding-right: 20px; text-align: right;">@gastoMesAnterior.ToString("C", new CultureInfo("es-AR"))</td>
                        <td scope="row" id="MesActual" style="padding-right: 20px; text-align: right;@(@gastoMesActual >= @gastoMesAnterior ? @colorMayor : @colorMenor)">@gastoMesActual.ToString("C", new CultureInfo("es-AR"))</td>
                        <td scope="row" id="MesSiguiente" style="padding-right: 20px; text-align: right;@(@gastoMesSiguiente >= @gastoMesActual ? @colorMayor : @colorMenor)">@gastoMesSiguiente.ToString("C", new CultureInfo("es-AR"))</td>
                        <td scope="row" id="Resumen">@entidad.Resumen.ToUpper()</td>
                        <td scope="row" id="Observaciones">@entidad.Observaciones</td>
                        <td scope="row" id="Verificado" align="center"><input id="CVerificado" type="checkbox" @checkedV></td>
                        <td scope="row" id="Reservado" align="center"><input id="CReservado" type="checkbox" @checkedR></td>
                        <td scope="row" id="Pagado" align="center"><input id="CPagado" type="checkbox" @checkedP></td>
                        <td scope="row" id="Activo"><input id="CPagado" type="checkbox" @checkedA></td>
                        <td data-toggle="collapse" data-target="@collapseN" aria-expanded="false" aria-controls="@collapse" class="collapsed">
                            <i class="fa" aria-hidden="false"></i>
                        </td>
                        <td scope="row">
                            <form method="post" asp-controller="@ViewBag.Modulo" asp-route-id="@entidad.Id">
                                <input type="text" name="Id" value="@entidad.Id" hidden="hidden" />
                                <button type="submit" class="btn btn-secondary" asp-controller="@ViewBag.Modulo" asp-action="GastosMensualesFormEdit" name="action" value="openFormEdit">Edit Entitty</button>
                                &nbsp;|&nbsp;
                                <button type="submit" class="btn btn-secondary" asp-controller="@ViewBag.Modulo" asp-action="GastosMensualesFormEdit" name="action" value="openFormView">View Entitty</button>
                            </form>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="9" id="@collapse" class="collapse acc" data-parent="#accordion">
                            <div class="dv3">
                                <table class="table myaccordion table-hover" id="accordion">
                                    <thead>
                                        <tr style="padding-right: 20px; text-align: right;">
                                            <th scope="col">Enero</th>
                                            <th scope="col">Febrero</th>
                                            <th scope="col">Marzo</th>
                                            <th scope="col">Abril</th>
                                            <th scope="col">Mayo</th>
                                            <th scope="col">Junio</th>
                                            <th scope="col">Julio</th>
                                            <th scope="col">Agosto</th>
                                            <th scope="col">Septiembre</th>
                                            <th scope="col">Octubre</th>
                                            <th scope="col">Noviembre</th>
                                            <th scope="col">Diciembre</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr style="padding-right: 20px; text-align: right;">
                                            <th scope="row" id="Enero" style="@(@mesActual == 1 ? "background-color: #3CE8DF;" : string.Empty)">@entidad.Enero.ToString("C", new CultureInfo("es-AR"))</th>
                                            <th scope="row" id="Febrero" style="@(@mesActual == 2 ? "background-color: #3CE8DF;" : string.Empty)">@entidad.Febrero.ToString("C", new CultureInfo("es-AR"))</th>
                                            <th scope="row" id="Marzo" style="@(@mesActual == 3 ? "background-color: #3CE8DF;" : string.Empty)">@entidad.Marzo.ToString("C", new CultureInfo("es-AR"))</th>
                                            <th scope="row" id="Abril" style="@(@mesActual == 4 ? "background-color: #3CE8DF;" : string.Empty)">@entidad.Abril.ToString("C", new CultureInfo("es-AR"))</th>
                                            <th scope="row" id="Mayo" style="@(@mesActual == 5 ? "background-color: #3CE8DF;" : string.Empty)">@entidad.Mayo.ToString("C", new CultureInfo("es-AR"))</th>
                                            <th scope="row" id="Junio" style="@(@mesActual == 6 ? "background-color: #3CE8DF;" : string.Empty)">@entidad.Junio.ToString("C", new CultureInfo("es-AR"))</th>
                                            <th scope="row" id="Julio" style="@(@mesActual == 7 ? "background-color: #3CE8DF;" : string.Empty)">@entidad.Julio.ToString("C", new CultureInfo("es-AR"))</th>
                                            <th scope="row" id="Agosto" style="@(@mesActual == 8 ? "background-color: #3CE8DF;" : string.Empty)">@entidad.Agosto.ToString("C", new CultureInfo("es-AR"))</th>
                                            <th scope="row" id="Septiembre" style="@(@mesActual == 9 ? "background-color: #3CE8DF;" : string.Empty)">@entidad.Septiembre.ToString("C", new CultureInfo("es-AR"))</th>
                                            <th scope="row" id="Octubre" style="@(@mesActual == 10 ? "background-color: #3CE8DF;" : string.Empty)">@entidad.Octubre.ToString("C", new CultureInfo("es-AR"))</th>
                                            <th scope="row" id="Noviembre" style="@(@mesActual == 11 ? "background-color: #3CE8DF;" : string.Empty)">@entidad.Noviembre.ToString("C", new CultureInfo("es-AR"))</th>
                                            <th scope="row" id="Diciembre" style="@(@mesActual == 12 ? "background-color: #3CE8DF;" : string.Empty)">@entidad.Diciembre.ToString("C", new CultureInfo("es-AR"))</th>

                                        </tr>
                                    </tbody>
                                </table>

                            </div>

                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    
</div>

<p></p>
<p>>>>>>&nbsp;&nbsp;@ViewBag.Ruta</p>
<a href="/Tarjetas" class="btn btn-secondary">Volver</a>

<script src="~/js/jquery.min.js"></script>
<script src="~/js/popper.js"></script>
<script src="~/js/bootstrap.min.js"></script>
<script src="~/js/main.js"></script>