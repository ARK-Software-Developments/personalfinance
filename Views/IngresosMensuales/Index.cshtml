@using PersonalFinance.Helper
@using PersonalFinance.Models.IngresosMensuales
@using System.Globalization
@{
    ViewData["Title"] = ViewBag.Title;
    ViewBag.Ruta = $"{ViewBag.Modulo} > {ViewBag.Title}";
    List<Ingreso> ingresos = ViewBag.Ingresos;

    DateTime fechaActual = DateTime.Now;

    string mesCompletoAnterior = Utils.LetraCapital(fechaActual.AddMonths(-1).ToString("MMMM", new CultureInfo("es-ES")));
    string mesCompletoActual = Utils.LetraCapital(fechaActual.ToString("MMMM", new CultureInfo("es-ES")));
    string mesCompletoSiguiente = Utils.LetraCapital(fechaActual.AddMonths(1).ToString("MMMM", new CultureInfo("es-ES")));
    var mesActual = DateTime.Now.Month;
    var colorMenor = "background-color: #E89B3C;";
    var colorMayor = "background-color: #A7C282;";
    var colorNeutro = "background-color: #F5EFC6;";

    List<SelectListItem> meses = new List<SelectListItem>();
    for (int i = 1; i <= 12; i++)
    {
        // Formatea el número del mes para obtener el nombre (ej: "Enero", "Febrero")
        string nombreMes = new DateTime(2023, i, 1).ToString("MMMM", new System.Globalization.CultureInfo("es-ES"));
        meses.Add(new SelectListItem { Text = nombreMes, Value = i.ToString() });
    }

    int anoAnterior = DateTime.Now.Year - 1;
    int anoActual = DateTime.Now.Year;
}


<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="~/css/personalfinance.styles.css">

<script>
     $(function () {
        $('[data-bs-toggle="tooltip"]').tooltip();
    });

 </script>

<div class="text-center">
    <h1 class="display-5">@ViewBag.Message</h1>
    <p>Listado de @ViewBag.Modulo.</p>
</div> 

<!-- Estructura del Modal -->
<div class="modal fade" id="miModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Proceso de copia de Ingreso Mensual</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Desea confirmar la copia del Ingreso del Año/Mes?.
            </div>
            <div class="modal-footer" style="display: ruby;">
                <form method="post" asp-controller="@ViewBag.Modulo">
                    <div class="form-group" style="display: ruby;">
                        <table style="position: center;">
                            <tr>
                                <td style="width:50%;">
                                    <div class="form-group">
                                        <span class="form-label">Mes desde:</span>
                                        <select id="MesDesde" name="MesDesde" class="form-control" required>
                                            @foreach (var item in @meses)
                                            {
                                                if (item.Selected)
                                                {
                                                    <option value="@item.Value" selected>@item.Text</option>
                                                }
                                                else
                                                {
                                                    <option value="@item.Value">@item.Text</option>
                                                }
                                            }
                                        </select>
                                        <span class="select-arrow"></span>
                                    </div>
                                </td>
                                <td style ="width:50%;">
                                    <div class="form-group">
                                        <span class="form-label">Año Desde:</span>
                                        <input type="text" id="AnoDesde" name="AnoDesde" class="form-control" value="@anoAnterior" required />
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:50%;">
                                    <div class="form-group">
                                        <span class="form-label">Mes hasta:</span>
                                        <select id="MesHasta" name="MesHasta" class="form-control" required>
                                            @foreach (var item in @meses)
                                            {
                                                if (item.Selected)
                                                {
                                                    <option value="@item.Value" selected>@item.Text</option>
                                                }
                                                else
                                                {
                                                    <option value="@item.Value">@item.Text</option>
                                                }
                                            }
                                        </select>
                                        <span class="select-arrow"></span>
                                    </div>
                                </td>
                                <td style="width:50%;">
                                    <div class="form-group">
                                        <span class="form-label">Año hasta:</span>
                                        <input type="text" id="AnoHasta" name="AnoHasta" class="form-control" value="@anoActual" required />
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:50%;"><button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cerrar</button>  </td>
                                <td style="width:50%;"><button type="submit" class="btn btn-primary" asp-controller="@ViewBag.Modulo" asp-action="IngresosMensuales" name="action" value="copyIncome">Confirmar</button></td>
                            </tr>
                        </table>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="tab-content">
    <table class="table myaccordion table-hover" id="accordion">
        <thead>
            <tr>
                <th scope="col">Id</th>
                <th scope="col">Codigo</th>
                <th scope="col">Detalle</th>
                <th scope="col" style="text-align: right; padding-right: 5px;">@mesCompletoAnterior</th>
                <th scope="col" style="text-align: right; padding-right: 5px;">@mesCompletoActual</th>
                <th scope="col" style="text-align: right; padding-right: 5px;">@mesCompletoSiguiente</th>
                <th scope="col" colspan="3" style="text-align: center;">
                    &nbsp;
                    <form method="post" asp-controller="@ViewBag.Modulo">
                        <button type="submit" class="btn btn-primary" asp-controller="@ViewBag.Modulo" asp-action="IngresosMensualesFormAdd" name="action" value="openFormAdd" title="Agregar nuevo item">Nuevo Ingreso</button>
                        &nbsp;|&nbsp;
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#miModal" title="Copiar presupuesto mes anterior">Copiar Ingreso</button>
                    </form>
                </th>
            </tr>
        </thead>
        <tbody>
            @foreach (var entidad in @ingresos)
            {
                var collapseN = "#collapse" + entidad.Id;
                var collapse = "collapse" + entidad.Id;
               
                var difMeses = Utils.CalcularDiferenciasMeses(mesActual, Utils.CargarMeses<Ingreso>(entidad));
                decimal gastoMesAnterior = difMeses["anterior"];
                decimal gastoMesActual = difMeses["actual"];
                decimal gastoMesSiguiente = difMeses["siguiente"];

                var colorActual = string.Empty;
                if (gastoMesActual > gastoMesAnterior)
                {
                    colorActual = colorMayor;
                }
                else if (gastoMesAnterior > gastoMesActual)
                {
                    colorActual = colorMenor;
                }
                else
                {
                    colorActual = colorNeutro;
                }

                var colorSiguiente = string.Empty;
                if (gastoMesSiguiente > gastoMesActual)
                {
                    colorSiguiente = colorMayor;
                }
                else if (gastoMesActual > gastoMesSiguiente)
                {
                    colorSiguiente = colorMenor;
                }
                else
                {
                    colorSiguiente = colorNeutro;
                }

                <tr>
                    <td scope="row" id="Id">@entidad.Id</td>
                    <td scope="row" id="Codigo">@entidad.TipoIngreso.Codigo.ToString().PadLeft(4, '0')</td>
                    <td scope="row" id="Detalle">@entidad.TipoIngreso.Detalle</td>
                    <td scope="row" id="@mesCompletoAnterior" style="padding-right: 20px; text-align: right;">@gastoMesAnterior.ToString("C", new CultureInfo("es-AR"))</td>
                    <td scope="row" id="@mesCompletoActual" style="padding-right: 20px; text-align: right;@colorActual">@gastoMesActual.ToString("C", new CultureInfo("es-AR"))</td>
                    <td scope="row" id="@mesCompletoSiguiente" style="padding-right: 20px; text-align: right;@colorSiguiente">@gastoMesSiguiente.ToString("C", new CultureInfo("es-AR"))</td>
                    <td scope="row"  data-toggle="collapse" data-target="@collapseN" aria-expanded="false" aria-controls="@collapse" class="collapsed">
                        &nbsp;
                        <i class="fa" aria-hidden="false"></i>
                    </td>
                    <td scope="row" style="text-align: center;">
                        <form method="post" asp-controller="@ViewBag.Modulo" asp-route-id="@entidad.Id">
                            <input type="text" name="Id" value="@entidad.Id" hidden="hidden" />
                            <button type="submit" class="btn btn-secondary" asp-controller="@ViewBag.Modulo" asp-action="IngresosMensualesFormEdit" name="action" value="openFormEdit">Edit Entitty</button>
                            &nbsp;|&nbsp;
                            <button type="submit" class="btn btn-secondary" asp-controller="@ViewBag.Modulo" asp-action="IngresosMensualesFormEdit" name="action" value="openFormView">View Entitty</button>
                        </form>
                    </td>
                </tr>
                <tr>
                    <td colspan="6" id="@collapse" class="collapse acc" data-parent="#accordion">
                        <div class="dv3">
                            <table class="table myaccordion table-hover" id="accordion">
                                <thead>
                                    <tr style ="padding-right: 20px; text-align: right;">
                                        <th scope="col">Enero</th>
                                        <th scope="col">Febrero</th>
                                        <th scope="col">Marzo</th>
                                        <th scope="col">Abril</th>
                                        <th scope="col">Mayo</th>
                                        <th scope="col">Junio</th>
                                        <th scope="col">Julio</th>
                                        <th scope="col">Agosto</th>
                                        <th scope="col">Septiembre</th>
                                        <th scope="col">Octubre</th>
                                        <th scope="col">Noviembre</th>
                                        <th scope="col">Diciembre</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr style="padding-right: 20px; text-align: right;">
                                        <th scope="row" id="Enero" style="@(@mesActual == 1 ? "background-color: #3CE8DF;" : string.Empty)">@entidad.Enero.ToString("C", new CultureInfo("es-AR"))</th>
                                        <th scope="row" id="Febrero" style="@(@mesActual == 2 ? "background-color: #3CE8DF;" : string.Empty)">@entidad.Febrero.ToString("C", new CultureInfo("es-AR"))</th>
                                        <th scope="row" id="Marzo" style="@(@mesActual == 3 ? "background-color: #3CE8DF;" : string.Empty)">@entidad.Marzo.ToString("C", new CultureInfo("es-AR"))</th>
                                        <th scope="row" id="Abril" style="@(@mesActual == 4 ? "background-color: #3CE8DF;" : string.Empty)">@entidad.Abril.ToString("C", new CultureInfo("es-AR"))</th>
                                        <th scope="row" id="Mayo" style="@(@mesActual == 5 ? "background-color: #3CE8DF;" : string.Empty)">@entidad.Mayo.ToString("C", new CultureInfo("es-AR"))</th>
                                        <th scope="row" id="Junio" style="@(@mesActual == 6 ? "background-color: #3CE8DF;" : string.Empty)">@entidad.Junio.ToString("C", new CultureInfo("es-AR"))</th>
                                        <th scope="row" id="Julio" style="@(@mesActual == 7 ? "background-color: #3CE8DF;" : string.Empty)">@entidad.Julio.ToString("C", new CultureInfo("es-AR"))</th>
                                        <th scope="row" id="Agosto" style="@(@mesActual == 8 ? "background-color: #3CE8DF;" : string.Empty)">@entidad.Agosto.ToString("C", new CultureInfo("es-AR"))</th>
                                        <th scope="row" id="Septiembre" style="@(@mesActual == 9 ? "background-color: #3CE8DF;" : string.Empty)">@entidad.Septiembre.ToString("C", new CultureInfo("es-AR"))</th>
                                        <th scope="row" id="Octubre" style="@(@mesActual == 10 ? "background-color: #3CE8DF;" : string.Empty)">@entidad.Octubre.ToString("C", new CultureInfo("es-AR"))</th>
                                        <th scope="row" id="Noviembre" style="@(@mesActual == 11 ? "background-color: #3CE8DF;" : string.Empty)">@entidad.Noviembre.ToString("C", new CultureInfo("es-AR"))</th>
                                        <th scope="row" id="Diciembre" style="@(@mesActual == 12 ? "background-color: #3CE8DF;" : string.Empty)">@entidad.Diciembre.ToString("C", new CultureInfo("es-AR"))</th>

                                    </tr>
                                </tbody>
                            </table>
                            
                        </div>
                        
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<p></p>
<p>>>>>>&nbsp;&nbsp;@ViewBag.Ruta</p>
<a href="/Tarjetas" class="btn btn-secondary">Volver</a>

<script src="~/js/jquery.min.js"></script>
<script src="~/js/popper.js"></script>
<script src="~/js/bootstrap.min.js"></script>
<script src="~/js/main.js"></script>